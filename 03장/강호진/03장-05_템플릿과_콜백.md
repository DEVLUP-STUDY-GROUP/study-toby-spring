# 3장 템플릿

## 3.5 템플릿과 콜백

- 템플릿/콜백 패턴: 전략패턴의 기본 구조에 익명 내부 클래스를 활용한 방식
- **전략 패턴의 컨텍스트를 템플릿이라 부르고, 익명 내부 클래스로 만들어지는 오브젝트를 콜백이라고 부름**
- 템플릿(template)
    - 어떤 목적을 위해 미리 만들어둔 모양이 있는 틀
    - 고정된 틀 안에 바뀔 수 있는 부분을 넣어서 사용하는 경우 템플릿이라고 부름
    - 템플릿 메소드 패턴은 고정된 틀의 로직을 가진 템플릿 메소드를 슈퍼클래스에 두고 바뀌는 부분을 서브클래스의 메소드에 두는 구조
- 콜백(callback)
    - 실행되는 것을 목적으로 다른 오브젝트의 메소드에 전달되는 오브젝트
    - 파라미터로 전달되지만 값을 참조하기 위한 것이 아니라 특정 로직을 담은 메소드를 실행시키기 위해 사용
    - 자바에서는 메소드 자체를 파라미터로 전달할 방법이 없기 때문에 메소드가 담긴 오브젝트를 전달
    - functional object라고도 함

### 3.5.1 템플릿/콜백의 동작원리

- 템플릿은 고정된 작업 흐름을 가진 코드를 재사용한다는 의미에서 붙인 이름
- 콜백은 템플릿 안에서 호출되는 것을 목적으로 만들어진 오브젝트
- 템플릿/콜백 패턴의 콜백은 보통 단일 메소드 인터페이스를 사용, 템플릿의 작업 흐름 중 특정 기능을 위해 한 번 호출되는 경우가 일반적
- 콜백은 일반적으로 하나의 메소드를 가진 인터페이스를 구현한 익명 내부 클래스로 만들어짐
- 콜백 인터페이스의 메소드에 파라미터는 템플릿의 작업 흐름 중에 만들어지는 컨텍스트 정보를 전달받을 때 사용
- 템플릿/콜백 패턴의 일반적인 작업 흐름
    - 클라이언트의 역할은 템플릿 안에서 실행될 로직을 담은 콜백 오브젝트를 만들고, 콜백이 참조할 정보를 제공
        - 만들어진 콜백은 클라이언트가 템플릿의 메소드를 호출할 때 파라미터로 전달
    - 템플릿은 정해진 작업 흐름을 따라 작업을 진행하다가 내부에서 생성한 참조 정보를 가지고 콜백 오브젝트의 메소드를 호출
        - 콜백은 클라이언트 메소드에 있는 정보와 템플릿이 제공한 참조정보를 이용해서 작업을 수행하고 그 결과를 다시 템플릿에 돌려줌
    - 템플릿은 콜백이 돌려준 정보를 사용해서 작업을 마저 수행, 경우에 따라 최종 결과를 클라이언트에게 돌려줌
- DI 방식의 전략 패턴 구조, 클라이언트가 템플릿 메소드를 호출하면서 콜백 오브젝트를 전달하는 것은 메소드 레벨에서 일어나는 DI
- 상황이 동시에 발생
    - 템플릿이 사용할 콜백 인터페이스를 구현한 오브젝트가 메소드를 통해 주입해주는 DI 작업
    - 클라이언트가 템플릿 기능을 호출

<p align="center">
  <img src="./img/03-07_khj.png" align="center" width="45%" alt="템플릿/콜백의 작업 흐름" style="margin-right: 1%;">
  <img src="./img/03-08_khj.png" align="center" width="45%" alt="UserDao/JdbcContext/StatementStrategy에 적용된 템플릿/콜백 패턴">
</p>

- 템플릿/콜백의 고유한 특징
    - 템플릿/콜백 방식에서는 매번 메소드 단위로 사용할 오브젝트를 새롭게 전달받음
    - 콜백 오브젝트가 내부 클래스로서 자신을 생성한 클라이언트 메소드 내의 정보를 직접 참조
    - 클라이언트와 콜백이 강하게 결합된다는 면에서도 일반적인 DI와 다름
- 템플릿/콜백 방식은 전략 패턴과 DI의 장점을 익명 내부 클래스 사용 전략과 결합한 독특한 활용법
    - 템플릿/콜백을 하나의 고유한 디자인 패턴으로 기억

### 3.5.2 편리한 콜백의 재활용

- DAO 메소드에서 매번 익명 내부 클래스를 사용하기 때문에 상대적으로 작성하고, 읽기가 불편함
- 복잡한 익명 내부 클래스의 사용을 최소화할 수 있는 방법 → 재활용 가능한 콜백을 담은 메소드
- 변하는 것과 변하지 않는 것을 분리하고 변하지 않는건 유연하게 재활용할 수 있게 만든다는 간단한 원리를 적용
- 하나의 목적을 위해 서로 긴밀하게 연관되어 동작하는 응집력이 강한 코드들은 한군데 모여 있는게 유리
- 구체적인 구현과 내부의 전략 패턴, 코드의 의한 DI, 익명 내부 클래스 등의 기술은 최대한 감춰둠
    - 외부에는 꼭 필요한 기능을 제공하는 단순한 메소드만 노출

### 3.5.3 템플릿/콜백의 응용

- 템플릿/콜백 패턴도 DI와 객체지향 설계를 적극적으로 응용한 결과
- 스프링이 내장된 것을 윈리도 알지 못한 채로 기계적으로 사용하는 경우와 적용된 패턴을 이해하고 사용하는 경우 큰 차이가 있음
    - 스프링이 제공하는 대부분의 기술은 그 구조를 이해하면 손쉽게 확장해서 사용 가능
- 고정된 작업 흐름을 갖고 있으면서 여기저기 자주 반복되는 코드가 있다면 중복되는 코드를 분리할 방법을 생각해보는 습관을 기를 것
    - 중복된 코드는 먼저 메소드로 분리
    - 그중 일부 작업을 필요에 따라 바꾸어 사용해야 한다면 인터페이스를 사이에 두고 분리
        - 전략 패턴을 적용하고 DI로 의존관계를 관리하도록 만듦
    - 바뀌는 부분이 한 애플리케이션 안에서 동시에 여러 종류가 만들어질 수 있다면 템플릿/콜백 패턴을 적용 가능
    - 가장 전형적인 템플릿/콜백 패턴 후보는 `try/catch/finally` 블록을 사용하는 코드
    - 일정한 리소스를 만들거나 가져와 작업하면서 예외가 발생할 가능성이 있는 코드는 보통 `try/catch/finally` 구조로 만들어짐
        - 예외 상황을 처리하기 위한 catch가 필요
        - 리소스를 반납하거나 제거하는 finally가 필요
    - 코드가 자주 반복된다면 템플릿/콜백 패턴을 적용하기 적당함
- 코드의 반복이 세 번 이상 된다면 본격적으로 코드를 개선할 시점이라고 생각해야 함
    - 객체지향 언어를 사용하고 객체지향 설계를 통해 코드를 작성하는 개발자의 기본적인 자세
- 템플릿/콜백을 적용할 때는 템플릿과 콜백의 경계를 정함
    - 템플릿이 콜백에게, 콜백이 템플릿에게 각각 전달하는 내용이 무엇인지 파악하는 게 가장 중요
    - 콜백의 인터페이스를 정의해야 하기 때문
- 템플릿과 콜백을 찾아낼 때는 변하는 코드의 경계를 찾고 그 경계를 사이에 두고 주고받는 일정한 정보가 있는지 확인
- 콜백이라는 이름이 의미하는 것처럼 다시 불려지는 기능을 만들어서 보냄
    - 템플릿과 콜백, 클라이언트 사이에 정보를 주고받는 일이 처음에는 복잡하게 느껴짐
    - 코드의 특성이 바뀌는 경계를 잘 살피고 그것을 인터페이스를 사용해 분리
    - 가장 기본적인 객체지향 원칙에만 충실하면 어렵지 않게 템플릿/콜백 패턴을 만들어 활용 가능
- 결과의 타입을 다양하게 가져가고 싶다면, 자바 언어에 타입 파라미터라는 개념을 도입한 제네릭스(Generics)를 이용하면 됨
- 스프링의 템플릿/콜백 패턴이 적용된 곳에서 종종 사용되는 기법
    - 리턴값을 갖는 템플릿
    - 템플릿 내에서 여러 번 호출되는 콜백 오브젝트
    - 제네릭 타입을 갖는 메소드
    - 콜백 인터페이스