# 1장 오브젝트와 의존관계

## 1.6 싱글톤 레지스트리와 오브젝트 스코프

### 1.6.0 들어가기

- 오브젝트의 동일성 (equality, `==`):  **하나의 오브젝트, 두 개의 오브젝트 레퍼런스 변수를 가짐**
- 오브젝트의 동등성 (identity, `equals()`): **두개의 오브젝트, 두 개의 오브젝트 레퍼런스 변수를 가짐**
    - 오브젝트의 동등성 기준에 따라 두 오브젝트의 정보가 동등하다고 판단
- 스프링은 여러 번에 걸쳐 빈을 요청하더라도 매번 동일한 오브젝트를 돌려줌, 내부에서 생성하는 빈 오브젝트를 싱글톤으로 생성

### 1.6.1 싱글톤 레지스트리로서의 애플리케이션

- 애플리케이션 컨텍스트(싱글톤 레지스트리)는 오브젝트 팩토리와 비슷한 방식으로 동작하는 IoC 컨테이너
    - **싱글톤 레지스트리 (sigleton registry): 싱글톤을 저장하고 관리**
- 스프링이 싱글톤으로 빈을 만드는 이유
    - **스프링은 엔터프라이즈 시스템을 위해 고안된 기술, 서버 환경에서 사용될 때 그 가치가 있음, 대부분 서버 환경에서 사용**
    - 매번 클라이언트에서 요청이 올 때마다 각 로직을 담당하는 오브젝트를 새로 만들어 사용하면 서버가 감당하기 힘듦
    - 서블릿은 자바 엔터프라이즈 기술의 가장 기본이 되는 서비스 오브젝트, 서블릿은 대부분 멀티스레드 환경에서 싱글톤으로 동작
    - 서블릿은 클래스당 하나의 오브젝트만 만들어두고, 사용자의 요청을 담당하는 여러 스레드에서 하나의 오브젝트를 공유해 동시 사용
- 싱글톤 패턴 (Singleton Pattern)
    - **원리: 애플리케이션 안에 제한된 수, 일반적으로 한 개의 오브젝트만 만들어서 사용하는 것**
    - 서버환경에서는 서비스 싱글톤의 사용이 권장되지만, 피해야 할 패턴이라는 의미로 안티패턴 (anti pattern)이라고도 불림
    - 디자인 패턴 중 가장 자주 활용되는 패턴이기도 하지만 가장 많은 비판을 받는 패턴
    - 어떤 클래스를 애플리케이션 내에서 제한된 인스턴스 개수, 주로 하나만 존재하도록 강제하는 패턴
    - 하나만 만들어지는 클래스의 오브젝트는 애플리케이션 내에서 전역적으로 접근 가능
    - 단일 오브젝트만 존재해야 하고 이를 애플리케이션의 여러 곳에서 공유하는 경우 주로 사용
- 자바에서 싱글톤을 구현하는 방법
    - 클래스 밖에서는 오브젝트를 생성하지 못하도록 생성자를 private로 생성
    - 생성된 싱글톤 오브젝트를 저장할 수 있는 자신과 같은 타입의 스태틱 필드를 정의
    - 스태틱 팩토리 메소드인 getInstance()를 만들고, 최초로 호출되는 시점에서 한 번만 오브젝트가 만들어지게 함
        - 생성된 오브젝트는 스태틱 필드에 저장, 또는 스태틱 필드의 초기값으로 오브젝트를 미리 만들어둘 수도 있음
    - 한번 오브젝트(싱글톤)이 만들어지고 난 후에는 getInstance() 메소드를 통해 이미 만들어져 스태틱 필드에 저장해둔 오브젝트를 넘겨줌
- 싱글톤 패턴 구현 방식의 문제점
    - **private 생성자를 가지고 있기 때문에 상속 불가**
        - 싱글톤 패턴은 생성자를 private로 제한, 오직 싱글톤 클래스 자신만이 자기 오브젝트를 만들도록 제한
        - private 생성자를 가진 클래스는 다른 생성자가 없다면 상속 불가능
        - 상속과 다형성과 같은 객체지향의 특징이 적용되지 않은 스태틱 필드와 메소드를 사용
    - **싱글톤은 테스트하기 어려움**
        - 테스트하기 어렵거나 테스트 방법에 따라 아예 테스트 불가
        - 만들어지는 방식이 제한적이기 때문에 테스트에서 사용될 때 목 (Mock) 오브젝트 등으로 대체가 힘듦
        - 초기화 과정에서 생성자 등을 통해 사용할 오브젝트를 다이나믹하게 주입하기 힘듦
            - 필요한 오브젝트는 직접 오브젝트를 만들어 사용할 수 밖에 없음
    - **서버 환경에서는 싱글톤이 하나만 만들어지는 것을 보장하지 못함**
        - 서버에서 클래스 로더를 어떻게 구성하고 있느냐에 따라서 싱글톤 클래스임에도 하나 이상의 오브젝트가 만들어질 수 있음
        - 자바 언어를 이용한 싱글톤 패턴 기법은 서버환경에서는 싱글톤이 꼭 보장된다고 볼 수 없음
        - 여러 개의 JVM에 분산되어 설치가 되는 경우에도 각각 독립적으로 오브젝트가 생기기 때문에 싱글톤으로서의 가치가 떨어짐
    - **싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못함**
        - 싱글톤은 사용하는 클라이언트가 정해져 있지 않음
        - 싱글톤의 스태틱 메소드를 이용해 언제든지 싱글톤에 쉽게 접근할 수 있기 때문에 애플리케이션 어디서든지 사용될 수 있음
        - 전역 상태 gobal state로 사용되기 쉬움, 아무 객체나 자유롭게 접근하고 수정하고 공유할 수 있는 전역 상태를 가짐
            - 객체지향 프로 그래밍에서는 권장되지 않는 프로그래밍 모델
- 싱글톤 레지스트리 (Singleton Registry)
    - **스프링이 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능**
        - 자바의 기본적인 싱글톤 패턴의 구현 방식은 여러 가지 단점이 있기 때문
        - 스프링은 서버환경에서 싱글톤이 만들어져서 서비스 오브젝트 방식으로 사용되는 것을 적극 지지
    - 스프링 컨테이너: 싱글톤을 생성하고, 관리하고, 공급하는 싱글톤 관리 컨테이너 역할
    - 싱글톤 레지스트리의 장점
        - 스태틱 메소드와 private 생성자를 사용해야 하는 비정상적인 클래스가 아니라 평범한 자바 클래스를 싱글톤으로 활용 가능
        - 평범한 자바 클래스라도 IoC 방식의 컨테이너를 사용해서 생성과 관계설정, 사용 등에 대한 제어권을 컨테이너에게 전환 시, 손쉽게 싱글톤 방식으로 만들어져 관리 가능
        - 오브젝트 생성에 관한 모든 권한은 IoC 기능을 제공하는 애플리케이션 컨텍스트에게 있기 때문
        - 스프링의 싱글톤 레지스트리 덕분에 싱글톤 방식으로 사용될 애플리케이션 클래스라도 public 생성자를 가질 수 있음
            - 싱글톤으로 사용돼야 하는 환경이 아니라면 간단히 오브젝트를 생성해서 사용 가능
            - 테스트 환경에서 자유롭게 오브젝트를 만들 수 있고, 테스트를 위한 목(Mock) 오브젝트로 대체 가능
        - 싱글톤 패턴과 달리 스프링이 지지하는 객체지향적인 설계 방식과 원칙, 디자인 패턴(싱글톤 패턴은 제외) 등을 적용하는 데 제약이 없음
            - 스프링은 IoC 컨테이너일 뿐만 아니라, 고전적인 싱글톤 패턴을 대신해서 싱글톤을 만들고 관리해주는 싱글톤 레지스트리
    - 스프링이 빈을 싱글톤으로 만드는 것 → 오브젝트의 생성 방법을 제어하는 IoC 컨테이너로서의 역할

### 1.6.2 싱글톤과 오브젝트의 상태

- 싱글톤은 멀티스레드 환경이라면 여러 스레드가 동시에 접근해서 사용 가능, 상태 관리에 주의 필요
    - 싱글톤이 멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우, 상태정보를 내부에 갖고 있지 않은 무상태(stateless) 방식으로 생성
    - 다중 사용자의 요청을 한꺼번에 처리하는 스레드들이 동시에 싱글톤 오브젝트의 인스턴스 변수를 수정하는 것은 매우 위험
        - 이유: 저장 공간이 하나뿐이므로 서로 값을 덮어쓰고, 자신이 저장하지 않은 값을 읽어올 수 있음
- 상태가 없는 방식으로 클래스를 만드는 경우에 각 요청에 대한 정보나, DB나 서버의 리소스로부터 생성한 정보는 파라미터와 로컬 변수, 리턴값 등을 이용
    - 이유: 메소드 파라미터나, 메소드 안에서 생성되는 로컬 변수는 새로운 값을 저장할 독립적인 공간이 만들어짐
- 자신이 사용하는 다른 싱글톤 빈을 저장하는 용도라면 인스턴스 변수로 사용 가능
    - 스프링이 한 번 초기화해주고 나면 이후에는 수정되지 않기 떄문에 멀티스레드 환경에서 사용해도 아무런 문제가 없음
- 읽기 전용의 속성을 가진 정보라면 싱글톤에서 인스턴스 변수로 사용해도 좋음
    - 단순한 읽기전용 값이라면 static final 이나, final로 선언하는 편이 좋음

### 1.6.3 스프링 빈의 스코프

- 빈의 스코프(scope)는 스프링 빈이 생성되고, 존재하고, 적용되는 범위
    - 기본 스코프는 싱글 톤, 스프링에서 만들어지는 대부분의 빈은 싱글톤 스코프
        - 싱글톤 스코프: 컨테이너 내에 한 개의 오브젝트만 만들어져서, 강제로 제거 하지 않는 한 스프링 컨테이너가 존재하는 동안 계속 유지
- 싱글톤 외의 스코프 예시
    - Prototype Scope: 은 컨테이너에 빈을 요청할 때마다 매번 새로운 오브젝트를 만듦
    - Request Scope: 웹을 통해 새로운 HTTP 요청이 생길 때마다 생성되는 요청 
    - Session Scope: 웹의 세션과 스코프가 유사한 세션 
    - 스프링에서 만들어지는 빈의 스코프는 싱글톤 외에도 다양한 스코프를 사용 가능